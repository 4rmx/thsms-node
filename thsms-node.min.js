const axios = require('axios').default;
const xmlParser = require('fast-xml-parser');

const config = {
    baseURL: "http://www.thsms.com",
    url: "api/rest",
    username: "",
    password: "",
}

const { baseURL, url, username, password } = config
const AXIOS = axios.create({
    baseURL: `${baseURL}/${url}`,
    params: {
        username: username,
        password: password
    }
});

async function parser(data, key) {
    try {
        const res = await xmlParser.parse(data)
        if (!res) return;
        const { service } = res
        if (service[key].status === 'success') {
            return service[key]
        }
        else if (service[key].status === 'fail') {
            return service[key].message
        }
    } catch (err) {
        throw err
    }
};

exports.credit = async () => {
    const METHOD = 'credit'
    try {
        return await AXIOS({
            params: {
                method: METHOD,
            },
        })
            .then(async result => {
                return await parser(result.data, METHOD)
            })
            .catch(err => {
                throw err
            })
    } catch (err) {
        throw err;
    }
};

exports.send = async (senderName = 'SMS', phoneNumber, message) => {
    const METHOD = 'send'
    try {
        return await AXIOS({
            url: `${baseURL}/${url}`,
            params: {
                method: METHOD,
                from: senderName,
                to: phoneNumber,
                message: message
            },
        })
            .then(async result => {
                return await parser(result.data, METHOD)
            })
            .catch(err => {
                throw err
            })

    } catch (err) {
        throw err;
    }
};